{% extends "base.html" %}

{% block head_links %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/detalle_rifa.css') }}">
{% endblock %}

{% block content %}

<!-- INPUT OCULTO: Usado por JS para obtener el ID de la rifa en el modal -->
<input type="hidden" id="raffle_id_input" value="{{ rifa.id }}">

<div class="container-fluid max-w-7xl mx-auto p-4 md:p-8">
<h1 class="text-2xl md:text-4xl font-extrabold text-gray-900 mb-3 text-center">{{ rifa.name }} (Rifa #{{ rifa.raffle_number }})</h1>

<!-- Botón para Abrir Modal de Info (Visible siempre) -->
<div class="d-flex justify-content-center mb-4">
    <button id="open-info-modal-button"
            data-bs-toggle="modal" data-bs-target="#raffle-info-modal-bs"
            class="btn inline-flex items-center px-6 py-3 border border-transparent text-base font-bold rounded-xl
            text-white bg-indigo-600 hover:bg-indigo-700 transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <i class="fas fa-info-circle me-2"></i> Ver Información de la Rifa
    </button>
</div>

<!-- INICIO: Alerta de Ganador Anunciado -->
{% if rifa.winning_numbers %}
<div class="alert alert-warning p-4 rounded-xl border-4 border-yellow-400 bg-yellow-50 shadow-lg mb-5" role="alert">
    <div class="d-flex flex-wrap align-items-center">
        <div class="flex-shrink-0 text-3xl text-yellow-800 me-4">
            <i class="fas fa-trophy"></i>
        </div>
        <div class="flex-grow-1">
            <h4 class="alert-heading text-xl font-bold text-yellow-800 mb-2">¡Ganador Anunciado!</h4>
            <ul class="list-unstyled space-y-3">
                {% for winning_number in rifa.winning_numbers %}
                {% set winner_info = get_winner_info(rifa.id, winning_number) %}
                {% if winner_info and 'status' not in winner_info %}
                <li class="bg-yellow-100 p-3 rounded-lg border border-yellow-300">
                    <p class="font-bold text-lg text-yellow-900 mb-1">
                        Número Ganador: {{ winning_number }}
                    </p>
                    <p class="text-gray-800 mb-0 ps-3">
                        <i class="fas fa-user me-1 text-yellow-700"></i> Cliente: <span class="font-extrabold">{{ winner_info.customer_name }}</span>
                        <i class="fas fa-phone me-1 text-yellow-700"></i> Teléfono: {{ winner_info.customer_phone }}
                    </p>
                </li>
                {% else %}
                <li class="d-flex flex-column bg-red-100 p-3 rounded-lg border border-red-300">
                    <span class="font-bold text-lg text-red-800">Número Ganador: {{ winning_number }}</span>
                    <span class="text-red-700 font-semibold mt-1">
                        {% if winner_info.status == 'CANCELADO' %}
                        <i class="fas fa-exclamation-triangle me-1"></i> ESTADO: CANCELADO (Cliente: {{ winner_info.customer_name }}, Teléfono: {{ winner_info.customer_phone }}).
                        {% else %}
                        <i class="fas fa-times-circle me-1"></i> ESTADO: NO VENDIDO / ELIMINADO.
                        {% endif %}
                    </span>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
            {% if current_user.is_authenticated and current_user.is_superuser() %}
            <hr class="my-3 border-yellow-300">
            <form action="{{ url_for('rifas.anunciar_ganador', raffle_id=rifa.id) }}" method="POST" class="mt-3">
                <input type="hidden" name="winner_action" value="remove_winners">
                <button type="submit" class="btn btn-sm btn-danger rounded-xl">
                    <i class="fas fa-undo me-2"></i> Eliminar Ganadores Anunciados
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
<!-- FIN: Alerta de Ganador Anunciado -->

<!-- Layout Principal: Formulario (Col-lg-4) y Números (Col-lg-8) -->
<div class="row g-4">

    <!-- Columna de Formulario (Desktop - Col-lg-4) -->
    <div class="col-12 col-lg-4">
        <div id="selection-form-container" class="h-fit sticky top-4 d-none d-lg-block p-4 bg-white rounded-xl border border-indigo-100 shadow-sm">
            <h2 class="text-2xl font-bold text-indigo-700 mb-3 border-bottom pb-2">Seleccionar Números</h2>
            <form method="POST" action="{{ url_for('rifas.detalle_rifa', raffle_id=rifa.id) }}" id="selection-form">
                <input type="hidden" name="action" value="add_selection">
                <input type="hidden" name="selected_numbers" id="selected_numbers_input" value="">

                <div class="mb-3 p-3 bg-pastel-blue rounded-xl border border-blue-300">
                    <label class="form-label text-sm font-medium text-gray-700 mb-1">Números a Comprar: <span id="desktop_total_amount" class="font-extrabold text-blue-900 ms-2"></span></label>
                    <span id="selected_numbers_display" class="d-block text-lg font-extrabold text-blue-800">Ninguno</span>
                </div>

                <div class="space-y-3">
                    <div>
                        <label for="customer_name" class="form-label text-sm font-medium text-gray-700">Nombre:</label>
                        <input type="text" name="customer_name" id="customer_name" required class="form-control rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3">
                    </div>
                    <div>
                        <label for="customer_phone" class="form-label text-sm font-medium text-gray-700">Teléfono (8 dígitos):</label>
                        <input type="tel" name="customer_phone" id="customer_phone" pattern="[0-9]{8}" maxlength="8" required class="form-control rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3">
                    </div>
                    <div>
                        <label for="selection_password" class="form-label text-sm font-medium text-gray-700">Contraseña de Protección:</label>
                        <div class="input-group mt-1">
                            <input type="password" name="selection_password" id="selection_password" required minlength="4" class="form-control rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3">
                            <button type="button" onclick="togglePasswordVisibility('selection_password')" class="btn btn-outline-secondary border-0 text-gray-500 hover:text-indigo-600 transition" style="border-top-right-radius: 0.75rem !important; border-bottom-right-radius: 0.75rem !important;">
                                <i class="fas fa-eye-slash" id="toggle_selection_password_icon"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Necesaria para proteger tu selección (solo podrás verla tú).</p>
                    </div>
                </div>

                <button type="submit" id="submit_button" disabled class="mt-3 w-full btn text-lg font-medium text-white transition-all duration-300 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-content-center">
                    <i class="fas fa-hand-pointer me-2"></i> Seleccione Números
                </button>
            </form>
        </div>
    </div>

    <!-- Columna de Números (Col-lg-8) -->
    <div class="col-12 col-lg-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Disponibilidad (00 a 99)</h2>
        <div class="mb-4 d-flex justify-content-center space-x-4 text-sm font-medium d-sm-block d-md-flex flex-wrap sm:space-x-0 sm:space-y-1 md:space-x-4 md:space-y-0">
            <span class="d-flex align-items-center"><span class="w-4 h-4 rounded-circle bg-pastel-green me-2 border border-green-700"></span> Disponible</span>
            <span class="d-flex align-items-center"><span class="w-4 h-4 rounded-circle bg-pastel-blue me-2 border border-blue-700"></span> Seleccionado</span>
            <span class="d-flex align-items-center"><span class="w-4 h-4 rounded-circle bg-pastel-red me-2 border border-red-700"></span> Vendido/Ocupado</span>
            <span class="d-flex align-items-center"><span class="w-4 h-4 rounded-circle bg-green-500 me-2 border border-green-700"></span> <span class="text-white bg-green-500 px-2 rounded-full">Cancelado</span></span>
        </div>

        <div class="p-3 bg-green-100 border border-green-300 rounded-xl mb-4 shadow-sm text-center">
            <h4 class="text-lg font-bold text-green-800 mb-0">
                Números Disponibles:
                <span class="text-2xl font-extrabold text-green-900">{{ 100 - total_numbers_occupied }}</span>
            </h4>
        </div>

        <div class="d-flex flex-wrap gap-2" id="numbers-grid">
            {% for i in range(100) %}
            {% set number_str = "%02d"|format(i) %}
            {% set selection_data = sold_numbers.get(number_str) %}
            {% set is_sold_or_canceled = selection_data is not none %}
            {% set is_sold = selection_data is not none and selection_data.is_canceled == 0 %}
            {% set is_canceled = selection_data is not none and selection_data.is_canceled == 1 %}
            <button type="button"
                    data-number="{{ number_str }}"
                    data-sold="{{ 'true' if is_sold_or_canceled else 'false' }}"
                    class="number-button text-center py-2 rounded-lg font-bold transition-all duration-150 min-w-[40px] max-w-[10%] flex-shrink-0 flex-grow border 
                    {% if is_sold %}bg-pastel-red text-red-800 cursor-not-allowed hover:shadow-inner border-red-700
                    {% elif is_canceled %}bg-green-500 text-white cursor-not-allowed hover:shadow-inner border-green-700
                    {% else %}bg-pastel-green text-green-800 hover:bg-green-300 hover:shadow-md border-green-300
                    {% endif %}"
                    {% if is_sold_or_canceled %}disabled{% endif %}>
                {{ number_str }}
                {% if is_canceled %}<i class="fas fa-ban text-sm ms-1 d-none d-sm-inline"></i>{% endif %}
            </button>
            {% endfor %}
        </div>
    </div>
</div>

<!-- INICIO: Botón de Reporte (SOLO SUPERUSUARIO) -->
{% if current_user.is_authenticated and current_user.is_superuser() %}
<div class="mt-5 text-center">
    <a href="{{ url_for('rifas.generar_reporte_txt', raffle_id=rifa.id) }}" class="btn bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-xl font-semibold transition shadow-md hover:shadow-lg">
        <i class="fas fa-file-alt me-2"></i> Generar Reporte TXT (Superusuario)
    </a>
</div>
{% endif %}
<!-- FIN: Botón de Reporte -->

<!-- INICIO: SECCIÓN MEJORADA DE NÚMEROS VENDIDOS -->
<div class="mt-5">
    <h2 class="text-3xl font-bold text-gray-800 mb-4 border-bottom pb-3">Números Vendidos y Ocupados</h2>

    {% if grouped_selections %}

    <!-- NUEVO: Sección de Resumen y Sinpe -->
    <div class="mb-4 p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-sm">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h4 class="text-xl font-bold text-indigo-800 mb-2">Resumen de Ventas</h4>
                <p class="mb-1 text-gray-700">
                    <i class="fas fa-ticket-alt me-2 text-indigo-500"></i>
                    <strong>{{ total_numbers_occupied }}</strong> números ocupados en total.
                </p>
                <p class="mb-0 text-gray-700">
                    <i class="fas fa-users me-2 text-indigo-500"></i>
                    <strong>{{ grouped_selections | length }}</strong> clientes únicos.
                </p>
            </div>
            <div class="col-md-6 mt-3 mt-md-0">
                {% if rifa.sinpe_phone_default %}
                <h4 class="text-lg font-bold text-green-800 mb-2">
                    <i class="fas fa-mobile-alt me-2"></i> Sinpe Móvil de la Rifa
                </h4>
                <p class="mb-1"><strong>Teléfono:</strong> {{ rifa.sinpe_phone_default }}</p>
                <p class="mb-0"><strong>Nombre:</strong> {{ rifa.sinpe_name_default or 'No especificado' }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Buscador con contador de resultados -->
    <div class="mb-4">
        <div class="input-group">
            <span class="input-group-text bg-gray-100 border-gray-300 rounded-l-xl"><i class="fas fa-search text-gray-500"></i></span>
            <input type="text"
                   id="search-input"
                   class="form-control p-3 border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 shadow-sm"
                   placeholder="Buscar por Número, Nombre o Teléfono..."
                   oninput="filterCards()">
            <span id="results-count" class="input-group-text bg-gray-100 border-gray-300 rounded-r-xl"></span>
        </div>
    </div>

    <!-- CONTENEDOR DE TARJETAS (SIN SCROLL FORZADO) -->
    <div id="cards-container">
        <div id="search-results-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for key, group in grouped_selections.items() %}
            {% set card_id = 'card-' ~ loop.index %}
            {% set group_total_price = group.numbers | length * rifa.price %}
            {% set formatted_price = "₡%s"|format("%.2f"|format(group_total_price) | replace('.', ',')) %}
            {% set numbers_list = (group.numbers | sort) | join(', ') %}
            {% set numbers_for_search = (group.numbers | sort) | join('') %}
            {% set selection_ids_list = (group.selection_ids | map('string') | join(',')) %}

            {% set card_base_class = 'card rounded-xl overflow-hidden h-100 shadow-sm' %}
            {% set header_base_class = 'card-header py-3 px-4' %}
            {% if group.is_canceled == 1 %}
            {% set text_color = 'text-green-800' %}
            {% set border_color = 'border-green-300' %}
            {% set bg_color = 'bg-pastel-green/50' %}
            {% set header_bg_color = 'bg-pastel-green' %}
            {% else %}
            {% set text_color = 'text-red-800' %}
            {% set border_color = 'border-red-300' %}
            {% set bg_color = 'bg-pastel-red/50' %}
            {% set header_bg_color = 'bg-pastel-red' %}
            {% endif %}

            <div class="col search-card"
                 data-name="{{ group.customer_name | lower }}"
                 data-phone="{{ group.customer_phone }}"
                 data-numbers="{{ numbers_list | replace(' ', '') | replace(',', '') }}">
                <div id="{{ card_id }}" class="{{ card_base_class }} {{ bg_color }} {{ border_color }}">
                    <div class="{{ header_base_class }} {{ header_bg_color }} {{ border_color }} d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 {{ text_color }} font-bold fs-6">
                                <i class="fas fa-user-circle me-2"></i> {{ group.customer_name }}
                            </h5>
                            <p class="mb-0 {{ text_color | replace('800', '700') }} text-sm">
                                <i class="fas fa-phone-alt me-2"></i> {{ group.customer_phone }}
                            </p>
                        </div>
                        {% if group.is_canceled == 1 %}
                        <span class="badge bg-green-700 text-white font-bold px-3 py-2 rounded-full">CANCELADO</span>
                        {% endif %}
                    </div>
                    <div class="card-body p-4 d-flex flex-column justify-content-between">
                        {% if current_user.is_authenticated and current_user.is_superuser() %}
                        <div class="mb-3 p-3 bg-indigo-50 border border-indigo-200 rounded-lg shadow-sm">
                            <p class="text-sm font-medium text-indigo-700 mb-1">Total de Venta ({{ group.numbers | length }} números):</p>
                            <p class="text-2xl font-extrabold text-indigo-800 mb-0">{{ formatted_price }}</p>
                        </div>
                        {% endif %}
                        <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
                            <span class="text-sm font-medium {{ text_color }}">Números:</span>
                            {% for number in (group.numbers | sort) %}
                            <span class="font-extrabold rounded-md px-2 py-1 text-sm
                                {% if group.is_canceled == 1 %} bg-green-400 text-white
                                {% else %} bg-red-400 text-white
                                {% endif %}">{{ number }}</span>
                            {% endfor %}
                        </div>
                        <div class="action-buttons mt-auto pt-3 border-top {{ border_color | replace('300', '200') }} d-flex flex-column gap-2">
                            
                            <!-- Botón 1: LIBERAR NÚMEROS (Requiere Contraseña de Protección) -->
                            <button onclick="openDeleteModal('{{ selection_ids_list }}', '{{ group.customer_name }}', '{{ numbers_list }}')"
                                    class="btn btn-sm w-100 inline-flex items-center justify-content-center font-medium rounded-xl transition bg-red-600 text-white hover:bg-red-700"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#delete-modal-bs">
                                <i class="fas fa-trash-alt me-1"></i> Liberar Números (Eliminar)
                            </button>
                            
                            <!-- Botón 2: Marcar como CANCELADO (Solo Superusuario) -->
                            {% if current_user.is_authenticated and current_user.is_superuser() %}
                            <form method="POST" action="{{ url_for('rifas.detalle_rifa', raffle_id=rifa.id) }}" class="d-inline-block w-100">
                                <input type="hidden" name="action" value="mark_canceled">
                                <input type="hidden" name="selection_ids" value="{{ selection_ids_list }}">
                                <button type="submit"
                                        class="btn btn-sm w-100 inline-flex items-center justify-content-center font-medium rounded-xl transition 
                                        {% if group.is_canceled == 1 %} btn-secondary disabled cursor-not-allowed
                                        {% else %} btn-warning text-white hover:bg-yellow-600 {% endif %}">
                                    <i class="fas fa-ban me-1"></i> {{ 'CANCELADO' if group.is_canceled == 1 else 'Marcar Cancelado (Admin)' }}
                                </button>
                            </form>
                            {% endif %}

                            <!-- Botones de Utilidad (WhatsApp y Exportar) -->
                            {% set sinpe_phone = rifa.sinpe_phone_default or 'No configurado' %}
                            {% set sinpe_name = rifa.sinpe_name_default or 'N/A' %}
                            
                            {% if current_user.is_authenticated and current_user.is_superuser() %}
                                <!-- Botón de WhatsApp -->
                                {% if group.customer_phone | length == 8 %}
                                {% set wa_text = "¡Hola *%s*! Te confirmo tu selección de número(s) para la rifa *%s* (#%s). Tus números son: *%s*.\n\nEl total a pagar es de: *%s*.\nLa fecha del sorteo es: *%s*.\n\nEl Sinpe Móvil para el pago es: *%s* (a nombre de: *%s*).\n\nPara confirmar su compra, por favor enviar el comprobante de pago."|format(group.customer_name, rifa.prize, rifa.raffle_number, numbers_list, formatted_price, rifa.raffle_date, sinpe_phone, sinpe_name) %}
                                <a href="https://wa.me/506{{ group.customer_phone }}?text={{ wa_text | urlencode }}" target="_blank" class="btn btn-sm w-100 mt-2 inline-flex items-center justify-content-center font-medium rounded-xl transition bg-green-600 text-white hover:bg-green-700">
                                    <i class="fab fa-whatsapp me-1"></i> Enviar Info por WhatsApp
                                </a>
                                {% endif %}
                                
                                <!-- Botón de Exportar a PNG -->
                                <div class="mt-2">
                                    {% set wa_message_export_no_dest = "¡Hola! Ya puedes encontrar la imagen de la tarjeta de tu(s) número(s) en tu galería de fotos.\n\n_El Sinpe Móvil para el pago es: *%s* (a nombre de: *%s*)._\n\nPor favor, adjúntala y envíala a tu cliente."|format(sinpe_phone, sinpe_name) %}
                                    <button type="button" onclick="exportCardToPng('{{ card_id }}', '{{ group.customer_name }}', '{{ rifa.raffle_number }}', '{{ group.customer_phone }}', '{{ wa_message_export_no_dest | urlencode }}')" class="w-full btn btn-sm bg-indigo-500 text-white font-medium rounded-xl transition hover:bg-indigo-600 shadow-md">
                                        <i class="fas fa-camera me-1"></i> Exportar Card a PNG y Enviar WA
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- MENSAJE DE NO RESULTADOS -->
        <div id="no-results-message" class="d-none text-center p-5 bg-gray-100 rounded-xl mt-4">
            <i class="fas fa-search fa-2x text-gray-400 mb-3"></i>
            <p class="text-xl text-gray-600 font-medium">No se encontraron coincidencias.</p>
        </div>
    </div>
    {% else %}
    <div class="text-center p-5 bg-gray-100 rounded-xl">
        <p class="text-xl text-gray-600 font-medium">¡Aún no hay números vendidos! Sé el primero.</p>
    </div>
    {% endif %}
</div>
<!-- FIN: SECCIÓN MEJORADA DE NÚMEROS VENDIDOS -->

</div>

<!-- Botón Flotante para Móvil (d-lg-none) -->
<button id="floating-select-button"
        data-bs-toggle="modal" data-bs-target="#selection-modal-bs"
        class="d-lg-none fixed bottom-3 left-1/2 transform -translate-x-1/2 z-40
        py-3 px-6 bg-indigo-600 text-white font-bold
        rounded-full hover:bg-indigo-700 transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled>
    <i class="fas fa-hand-pointer me-2"></i> Seleccionar Números
</button>

<!-- MODAL DE LIBERACIÓN DE NÚMEROS (DELETE SELECTION) -->
<div class="modal fade" id="delete-modal-bs" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-xl">
            <div class="modal-header border-bottom-0 pt-4 bg-red-50 rounded-top-xl">
                <h3 class="modal-title fs-5 font-bold text-red-700" id="deleteModalLabel">Liberar Números (Eliminar)</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="" id="delete-selection-form">
                <div class="modal-body pt-0">
                    <input type="hidden" name="action" value="delete_selection">
                    <input type="hidden" name="selection_ids" id="modal-delete-ids">
                    
                    <div class="p-3 bg-gray-50 rounded-lg mb-3 border border-red-200">
                        <p class="text-base text-gray-700 mb-1">
                            Está a punto de **liberar** los números: 
                            <span id="modal-delete-numbers-display" class="font-extrabold text-red-800 d-block mt-1"></span>
                        </p>
                        <p class="text-sm text-red-600 font-medium mb-0">
                            Cliente: <span id="modal-delete-name-display" class="font-semibold"></span>. Una vez liberados, cualquiera podrá comprarlos.
                        </p>
                    </div>

                    <div class="mb-3">
                        <label for="delete_password_input" class="form-label text-sm font-medium text-gray-700">Contraseña de Protección:</label>
                        <div class="input-group mt-1">
                            <input type="password" name="delete_password" id="delete_password_input" required minlength="4" class="form-control rounded-xl p-3">
                            <button type="button" onclick="togglePasswordVisibility('delete_password_input')" class="btn btn-outline-secondary border-0" style="border-top-right-radius: 0.75rem !important; border-bottom-right-radius: 0.75rem !important;">
                                <i class="fas fa-eye-slash" id="toggle_delete_password_input_icon"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Ingrese la contraseña que el cliente asignó al comprar para confirmar la liberación.</p>
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary rounded-xl" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger rounded-xl"><i class="fas fa-trash-alt me-2"></i> Confirmar Liberación</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- MODAL DE INFORMACIÓN DE RIFA (MANTENIDO) -->
<div class="modal fade" id="raffle-info-modal-bs" tabindex="-1" aria-labelledby="raffleInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-xl">
            <div class="modal-header border-bottom-0">
                <h2 class="modal-title text-2xl font-bold text-gray-800" id="raffleInfoModalLabel">Detalles de la Rifa</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-12 col-lg-6">
                        <div class="cursor-pointer" data-bs-toggle="modal" data-bs-target="#image-zoom-modal-bs" onclick="openZoomModal('{{ url_for('static', filename='uploads/' + rifa.image_filename) }}')">
                            <img src="{{ url_for('static', filename='uploads/' + rifa.image_filename) }}" alt="Imagen del Premio" class="rounded-lg object-cover w-full max-w-full h-48 md:h-64 mb-4 border border-gray-200" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e0e7ff/3f51b5?text=Sin+Imagen';">
                        </div>
                        <div class="space-y-3">
                            <p class="text-xl font-semibold text-indigo-700">Premio: <span class="text-2xl font-bold text-indigo-900">{{ rifa.prize }}</span></p>
                            <p class="text-gray-600"><i class="fas fa-calendar-alt me-2 text-indigo-500"></i> Fecha del Sorteo: <span class="font-medium text-gray-800">{{ rifa.raffle_date }}</span></p>
                            {% if rifa.raffle_time %}<p class="text-gray-600"><i class="fas fa-clock me-2 text-indigo-500"></i> Hora Estimada: <span class="font-medium text-gray-800">{{ rifa.raffle_time }}</span></p>{% endif %}
                            <p class="text-gray-600"><i class="fas fa-tag me-2 text-indigo-500"></i> Precio por Número: <span class="text-xl font-extrabold text-green-600">₡{{ "%.2f"|format(rifa.price) }}</span></p>
                            {% if current_user.is_authenticated and current_user.is_superuser() %}
                            <div class="mt-3"><a href="{{ url_for('rifas.editar_rifa', raffle_id=rifa.id) }}" class="btn btn-warning text-white font-medium rounded-xl hover:bg-yellow-600 transition"><i class="fas fa-edit me-2"></i> Editar Rifa (Admin)</a></div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-12 col-lg-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 border-bottom pb-1">Descripción:</h3>
                        <p class="text-gray-700 whitespace-pre-wrap">{{ rifa.detail }}</p>
                        {% if rifa.sinpe_phone_default %}
                        <div class="mt-4 p-3 bg-green-50 border border-green-300 rounded-lg shadow-sm">
                            <h4 class="text-lg font-bold text-green-800 mb-2"><i class="fas fa-mobile-alt me-1"></i> Sinpe Móvil de la Rifa</h4>
                            <p class="text-gray-700 mb-1"><span class="font-semibold">Teléfono:</span> {{ rifa.sinpe_phone_default }}</p>
                            <p class="text-gray-700 mb-0"><span class="font-semibold">Nombre Registrado:</span> {{ rifa.sinpe_name_default or 'No especificado' }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE SELECCIÓN DE NÚMEROS (Mobile) (MANTENIDO) -->
<div class="modal fade" id="selection-modal-bs" tabindex="-1" aria-labelledby="selectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content rounded-xl">
            <div class="modal-header border-bottom-0">
                <h2 class="modal-title text-2xl font-bold text-indigo-700" id="selectionModalLabel">Confirmar Compra</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar Modal" onclick="returnToSelection()"></button>
            </div>
            <div class="modal-body p-4">
                <form method="POST" action="{{ url_for('rifas.detalle_rifa', raffle_id=rifa.id) }}" id="selection-modal-form">
                    <input type="hidden" name="action" value="add_selection">
                    <input type="hidden" name="selected_numbers" id="modal_selected_numbers_input" value="">
                    <div class="mb-3 p-3 bg-pastel-blue rounded-xl border border-blue-300">
                        <label class="form-label text-sm font-medium text-gray-700 mb-1">Números a Comprar: <span id="modal_total_amount" class="font-extrabold text-blue-900 ms-2"></span></label>
                        <span id="modal_selected_numbers_display" class="d-block text-lg font-extrabold text-blue-800">Ninguno</span>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label for="modal_customer_name" class="form-label text-sm font-medium text-gray-700">Nombre:</label>
                            <input type="text" name="customer_name" id="modal_customer_name" required class="form-control rounded-xl p-3">
                        </div>
                        <div>
                            <label for="modal_customer_phone" class="form-label text-sm font-medium text-gray-700">Teléfono (8 dígitos):</label>
                            <input type="tel" name="customer_phone" id="modal_customer_phone" pattern="[0-9]{8}" maxlength="8" required class="form-control rounded-xl p-3">
                        </div>
                        <div>
                            <label for="modal_selection_password" class="form-label text-sm font-medium text-gray-700">Contraseña de Protección:</label>
                            <div class="input-group mt-1">
                                <input type="password" name="selection_password" id="modal_selection_password" required minlength="4" class="form-control rounded-xl p-3">
                                <button type="button" onclick="togglePasswordVisibility('modal_selection_password')" class="btn btn-outline-secondary border-0" style="border-top-right-radius: 0.75rem !important; border-bottom-right-radius: 0.75rem !important;">
                                    <i class="fas fa-eye-slash" id="toggle_modal_selection_password_icon"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Necesaria para proteger tu selección (solo podrás verla tú).</p>
                        </div>
                    </div>
                    <button type="submit" id="modal_submit_button" disabled class="mt-3 w-full btn text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50">
                        <i class="fas fa-hand-pointer me-2"></i> Seleccione Números
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL Image Zoom (MANTENIDO) -->
<div class="modal fade" id="image-zoom-modal-bs" tabindex="-1" aria-labelledby="imageZoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content rounded-xl bg-black">
            <div class="modal-header border-bottom-0 bg-dark rounded-top-xl p-3">
                <h5 class="modal-title text-white" id="imageZoomModalLabel">Vista Ampliada</h5>
                <div>
                    <button type="button" class="btn btn-secondary btn-sm me-2" onclick="handleZoom(1)"><i class="fas fa-search-plus"></i></button>
                    <button type="button" class="btn btn-secondary btn-sm me-2" onclick="handleZoom(-1)"><i class="fas fa-search-minus"></i></button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-2 d-flex justify-content-center align-items-center overflow-auto">
                <img id="zoom-image" src="" alt="Imagen ampliada" class="max-w-full max-h-full object-contain transition-transform duration-300">
            </div>
        </div>
    </div>
</div>

<!-- Botón de Instalación PWA -->
{% if current_user.is_authenticated and current_user.is_superuser() %}
<div class="fixed bottom-0 left-0 w-full z-50 p-3 bg-white shadow-2xl border-t border-gray-200 d-flex justify-content-center">
    <button id="install-pwa-button" class="btn bg-indigo-600 text-white py-2 px-4 rounded-xl font-semibold" style="display: none;">
        <i class="fas fa-download me-2"></i> Instalar Aplicación (PWA)
    </button>
</div>
{% endif %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- AHORA IMPORTAMOS LOS DOS ARCHIVOS JS -->
<script src="{{ url_for('static', filename='js/detalle_rifa.js') }}"></script>
<script src="{{ url_for('static', filename='js/detalle_btns.js') }}"></script>

{% endblock %}
