{% extends "base.html" %}

{% block content %}
{# ELIMINACIÓN DE ESTILOS EN LÍNEA: El CSS de 'scrolling-fade' se movió a base.css #}

<div class="container-fluid max-w-7xl mx-auto p-4 md:p-8">
{# CAMBIO: Se usa text-2xl en móvil y md:text-4xl en escritorio para reducir el título #}
<h1 class="text-2xl md:text-4xl font-extrabold text-gray-900 mb-3 text-center">{{ rifa.name }} (Rifa #{{ rifa.raffle_number }})</h1>

<!-- Botón para Abrir Modal de Info (Visible siempre) -->

<div class="d-flex justify-content-center mb-4">
<button id="open-info-modal-button"
data-bs-toggle="modal" data-bs-target="#raffle-info-modal-bs"
class="btn inline-flex items-center px-6 py-3 border border-transparent text-base font-bold rounded-xl
text-white bg-indigo-600 hover:bg-indigo-700 transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
<i class="fas fa-info-circle me-2"></i> Ver Información de la Rifa
</button>
</div>

<!-- INICIO: Alerta de Ganador Anunciado -->

{% if rifa.winning_numbers %}

<div class="alert alert-warning p-4 rounded-xl border-4 border-yellow-400 bg-yellow-50 shadow-lg mb-5" role="alert">
<div class="d-flex flex-wrap align-items-center">
<div class="flex-shrink-0 text-3xl text-yellow-800 me-4">
<i class="fas fa-trophy"></i>
</div>
<div class="flex-grow-1">
<h4 class="alert-heading text-xl font-bold text-yellow-800 mb-2">¡Ganador Anunciado!</h4>

<ul class="list-unstyled space-y-3">
{% for winning_number in rifa.winning_numbers %}
{# Usamos la función del context_processor para obtener la info del ganador #}
{% set winner_info = get_winner_info(rifa.id, winning_number) %}

{% if winner_info and 'status' not in winner_info %}
{# Caso: Ganador Activo (is_canceled = 0) - Formato vertical mejorado #}
<li class="bg-yellow-100 p-3 rounded-lg border border-yellow-300">
<p class="font-bold text-lg text-yellow-900 mb-1">
Número Ganador: {{ winning_number }}
</p>
<p class="text-gray-800 mb-0 ps-3">
<i class="fas fa-user me-1 text-yellow-700"></i> Cliente: <span class="font-extrabold">{{ winner_info.customer_name }}</span>

<i class="fas fa-phone me-1 text-yellow-700"></i> Teléfono: {{ winner_info.customer_phone }}
</p>
</li>
{% else %}
{# Caso: No hay ganador activo o fue cancelado/eliminado - Formato conciso #}
<li class="d-flex flex-column bg-red-100 p-3 rounded-lg border border-red-300">
<span class="font-bold text-lg text-red-800">Número Ganador: {{ winning_number }}</span>
<span class="text-red-700 font-semibold mt-1">
{% if winner_info.status == 'CANCELADO' %}
<i class="fas fa-exclamation-triangle me-1"></i> ESTADO: CANCELADO (Cliente: {{ winner_info.customer_name }}, Teléfono: {{ winner_info.customer_phone }}).
{% else %}
<i class="fas fa-times-circle me-1"></i> ESTADO: NO VENDIDO / ELIMINADO.
{% endif %}
</span>
<span class="text-red-500 text-sm mt-1">
Vuelva a sortear o anuncie el suplente.
</span>
</li>
{% endif %}

{% endfor %}

</ul>

{% if current_user.is_authenticated and current_user.is_superuser() %}

<hr class="my-3 border-yellow-300">
<form action="{{ url_for('rifas.anunciar_ganador', raffle_id=rifa.id) }}" method="POST" class="mt-3">
<input type="hidden" name="winner_action" value="remove_winners">
<button type="submit" class="btn btn-sm btn-danger rounded-xl">
<i class="fas fa-undo me-2"></i> Eliminar Ganadores Anunciados
</button>
</form>
{% endif %}

</div>

</div>

</div>
{% endif %}
<!-- FIN: Alerta de Ganador Anunciado -->

<!-- Lógica de Agrupación de Datos en Jinja (OPTIMIZADA) -->

{% set grouped_selections = {} %}

{# Corrección: Calculamos el total de números ocupados directamente desde la longitud del diccionario #}
{% set total_numbers_occupied = sold_numbers | length %}

{% for selection in sold_numbers.values() %}
{% set customer_key = selection.customer_name ~ '|' ~ selection.customer_phone %}

{# Inicializar la entrada en el diccionario si no existe #}
{% if customer_key not in grouped_selections %}
{# Definición del nuevo grupo en una línea limpia para evitar errores de sintaxis #}
{% set new_group = {'customer_name': selection.customer_name, 'customer_phone': selection.customer_phone, 'created_at': selection.created_at, 'numbers': [], 'selection_ids': [], 'is_canceled': selection.is_canceled, 'payment_method': selection.payment_method, 'sinpe_name': selection.sinpe_name, 'sinpe_phone': selection.sinpe_phone} %}
{% set _ = grouped_selections.update({customer_key: new_group}) %}
{% endif %}

{# Añadir números y IDs #}
{% set _ = grouped_selections[customer_key].numbers.append(selection.number) %}
{% set _ = grouped_selections[customer_key].selection_ids.append(selection.id) %}

{# Nota: Como todos los números de este grupo tienen el mismo is_canceled (por el agrupamiento), habría que refactorizar la DB. Asumimos consistencia por ahora. #}
{% set _ = grouped_selections[customer_key].update({'is_canceled': selection.is_canceled}) %}

{% endfor %}

<!-- Layout Principal: Formulario (Col-lg-4) y Números (Col-lg-8) -->

<div class="row g-4">

<!-- Columna de Formulario (Desktop - Col-lg-4) -->

<div class="col-12 col-lg-4">
<!-- Contenedor del Formulario de Selección (Visible en LG y superior) -->
<div id="selection-form-container" class="h-fit sticky top-4
d-none d-lg-block p-4 bg-white rounded-xl border border-indigo-100">
<h2 class="text-2xl font-bold text-indigo-700 mb-3 border-bottom pb-2">Seleccionar Números</h2>
<form method="POST" action="{{ url_for('rifas.detalle_rifa', raffle_id=rifa.id) }}" id="selection-form">
<input type="hidden" name="action" value="add_selection">
<input type="hidden" name="selected_numbers" id="selected_numbers_input" value="">

<div class="mb-3 p-3 bg-pastel-blue rounded-xl border border-blue-300">
<label class="form-label text-sm font-medium text-gray-700 mb-1">Números a Comprar:</label>
<span id="selected_numbers_display" class="d-block text-lg font-extrabold text-blue-800">Ninguno</span>
</div>

<div class="space-y-3">
<div>
<label for="customer_name" class="form-label text-sm font-medium text-gray-700">Nombre:</label>
<input type="text" name="customer_name" id="customer_name" required class="form-control rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3">
</div>
<div>
<label for="customer_phone" class="form-label text-sm font-medium text-gray-700">Teléfono (8 dígitos):</label>
<input type="tel" name="customer_phone" id="customer_phone" pattern="[0-9]{8}" maxlength="8" required class="form-control rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3">
</div>

{# SECCIÓN ELIMINADA: MÉTODO DE PAGO DEL CLIENTE #}
{# Eliminado: <div class="pt-2 border-top border-gray-200 space-y-3">... #}
{# Eliminado: <div id="sinpe_fields_desktop" class="space-y-3 pt-2 d-none">... #}

<div>
<label for="selection_password" class="form-label text-sm font-medium text-gray-700">Contraseña de Protección:</label>
<div class="input-group mt-1">
<input type="password" name="selection_password" id="selection_password" required minlength="4" class="form-control rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3">
<button type="button" onclick="togglePasswordVisibility('selection_password')" class="btn btn-outline-secondary border-0 text-gray-500 hover:text-indigo-600 transition"
style="border-top-right-radius: 0.75rem !important; border-bottom-right-radius: 0.75rem !important;">
<i class="fas fa-eye-slash" id="toggle_selection_password_icon"></i>
</button>
</div>
<p class="text-xs text-gray-500 mt-1">Necesaria para editar/eliminar la selección más tarde.</p>
</div>
</div>

<button type="submit" id="submit_button" disabled class="mt-3 w-full btn text-lg font-medium text-white transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
Comprar Números Seleccionados
</button>

</form>

</div>

</div>

<!-- Columna de Números (Col-lg-8) -->

<div class="col-12 col-lg-8">
<h2 class="text-2xl font-bold text-gray-800 mb-3">Disponibilidad (00 a 99)</h2>
<div class="mb-4 d-flex justify-content-center space-x-4 text-sm font-medium d-sm-block d-md-flex flex-wrap sm:space-x-0 sm:space-y-1 md:space-x-4 md:space-y-0">
<span class="d-flex align-items-center w-full sm:w-1/2 md:w-auto sm:justify-center md:justify-start">
<span class="w-4 h-4 rounded-circle bg-pastel-green me-2 border border-green-700"></span> Disponible
</span>
<span class="d-flex align-items-center w-full sm:w-1/2 md:w-auto sm:justify-center md:justify-start">
<span class="w-4 h-4 rounded-circle bg-pastel-blue me-2 border border-blue-700"></span> Seleccionado
</span>
<span class="d-flex align-items-center w-full sm:w-1/2 md:w-auto sm:justify-center md:justify-start">
<span class="w-4 h-4 rounded-circle bg-pastel-red me-2 border border-red-700"></span> Vendido/Ocupado
</span>
<!-- NUEVO ESTADO: Cancelado (Visible para todos en verde, no solo Admin) -->
<span class="d-flex align-items-center w-full sm:w-1/2 md:w-auto sm:justify-center md:justify-start">
<span class="w-4 h-4 rounded-circle bg-green-500 me-2 border border-green-700"></span> <span class="text-green-700">Cancelado</span>
</span>
</div>

<!-- INFORMACIÓN DE NÚMEROS DISPONIBLES (Corregido para reflejar el conteo real) -->

<div class="p-3 bg-green-100 border border-green-300 rounded-xl mb-4 shadow-sm text-center">
<h4 class="text-lg font-bold text-green-800 mb-0">
Números Disponibles:
<span class="text-2xl font-extrabold text-green-900">{{ 100 - total_numbers_occupied }}</span>
</h4>
</div>

<!-- Grilla de Números: Usando Flexbox con tamaño base y envoltura -->

<div class="d-flex flex-wrap gap-2" id="numbers-grid">
{% for i in range(100) %}
{% set number_str = "%02d"|format(i) %}
{# Si el número existe en sold_numbers y NO está cancelado #}
{% set selection_data = sold_numbers.get(number_str) %}
{% set is_sold = selection_data is not none and selection_data.is_canceled == 0 %}
{# Usaremos una clase simple para mostrar los cancelados si queremos que se vean #}
{% set is_canceled = selection_data is not none and selection_data.is_canceled == 1 %}

<button type="button"
data-number="{{ number_str }}"
data-sold="{{ 'true' if is_sold or is_canceled else 'false' }}"
class="number-button text-center py-2 rounded-lg font-bold transition-all duration-150
min-w-[40px] max-w-[10%] flex-shrink-0 flex-grow

        {% if is_sold %}
            {# Vendido y Activo (Rojo Pastel) #}
            bg-pastel-red text-red-800 cursor-not-allowed hover:shadow-inner
        {% elif is_canceled %}
            {# Cancelado (Verde Sólido - Visible para todos) #}
            bg-green-500 text-white cursor-not-allowed hover:shadow-inner 
        {% else %}
            {# Disponible (Verde Pastel) #}
            bg-pastel-green text-green-800 hover:bg-green-300 hover:shadow-md
        {% endif %}"
{% if is_sold or is_canceled %}disabled{% endif %}>

{{ number_str }}

{% if is_canceled %}
    <i class="fas fa-ban text-sm ms-1 d-none d-sm-inline"></i>
{% endif %}

</button>

{% endfor %}

</div>

</div>

</div>

<!-- INICIO: Botón de Reporte (SOLO SUPERUSUARIO) -->
{% if current_user.is_authenticated and current_user.is_superuser() %}
<div class="mt-5 text-center">
    <!-- CORRECCIÓN: Apuntamos a la nueva función generar_reporte_txt -->
    <a href="{{ url_for('rifas.generar_reporte_txt', raffle_id=rifa.id) }}" 
       class="btn bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-xl font-semibold transition shadow-md hover:shadow-lg">
        <i class="fas fa-file-alt me-2"></i> Generar Reporte TXT (Superusuario)
    </a>
</div>
{% endif %}
<!-- FIN: Botón de Reporte -->

<!-- INICIO: Diseño de Tarjetas para Números Vendidos -->

<div class="mt-5">
<h2 class="text-3xl font-bold text-gray-800 mb-3 border-bottom pb-2">Números Vendidos y Ocupados</h2>

{% if grouped_selections %}

<!-- NUEVO BUSCADOR -->

<div class="mb-4">
<div class="input-group">
<span class="input-group-text bg-gray-100 border-gray-300 rounded-l-xl"><i class="fas fa-search text-gray-500"></i></span>
<input type="text"
id="search-input"
class="form-control p-3 border-gray-300 rounded-r-xl focus:border-indigo-500 focus:ring-indigo-500 shadow-sm"
placeholder="Buscar por Número, Nombre o Teléfono..."
oninput="filterCards()">
</div>
</div>

<!-- CONTENEDOR CON SCROLL Y DIFUMINADO (max-h-96 es eliminado para permitir scroll del body) -->

<div id="cards-scroll-wrapper" class="scrolling-fade relative" style="max-height: 400px;">
<div id="search-results-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
{% for key, group in grouped_selections.items() %}
{# ASIGNAR UN ID ÚNICO A CADA CARD PARA LA EXPORTACIÓN #}
{% set card_id = 'card-' ~ loop.index %}

{# Variables para el Card #}
{% set group_total_price = group.numbers | length * rifa.price %}
{% set formatted_price = "₡%s"|format("%.2f"|format(group_total_price) | replace('.', ',')) %}
{% set numbers_list = (group.numbers | sort) | join(', ') %}
{# Preparamos los números sin comas ni espacios para la búsqueda: "010512" #}
{% set numbers_for_search = (group.numbers | sort) | join('') %}

{# Clases condicionales para el card #}
{% set card_base_class = 'card rounded-xl overflow-hidden h-100' %}
{% set header_base_class = 'card-header py-3 px-4' %}
{% set text_color = 'text-red-800' %}
{% set border_color = 'border-red-300' %}
{% set bg_color = 'bg-pastel-red/50' %}

{% if group.is_canceled == 1 %}
{# Card Cancelado (Verde, visible para todos) #}
{% set text_color = 'text-green-800' %}
{% set border_color = 'border-green-300' %}
{% set bg_color = 'bg-pastel-green/50' %}
{% set header_bg_color = 'bg-pastel-green' %}
{% else %}
{# Card Vendido/Ocupado (Rojo) #}
{% set header_bg_color = 'bg-pastel-red' %}
{% endif %}

<div class="col search-card" 
     data-name="{{ group.customer_name | lower }}" 
     data-phone="{{ group.customer_phone }}" 
     data-payment="{{ group.payment_method | lower }}" 
     data-numbers="{{ numbers_list | replace(' ', '') | replace(',', '') }}">
    <div id="{{ card_id }}" class="{{ card_base_class }} {{ bg_color }} {{ border_color }}">

    <!-- Encabezado del Card: Nombre y Teléfono del Cliente -->
    <div class="{{ header_base_class }} {{ header_bg_color }} {{ border_color }} d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-0 {{ text_color }} font-bold fs-6">
                <i class="fas fa-user-circle me-2"></i> {{ group.customer_name }}
            </h5>
            <p class="mb-0 {{ text_color | replace('800', '700') }} text-sm">
                <i class="fas fa-phone-alt me-2"></i> {{ group.customer_phone }} 
                <span class="d-none d-lg-inline-block text-gray-600 ms-3">| Primer registro: {{ group.created_at }}</span>
            </p>
            
            <!-- NUEVO: Nombre y Sinpe de la RIFA (Aparece en el encabezado del Card) -->
            <p class="mb-0 text-xs text-indigo-700 font-semibold mt-1">
                <i class="fas fa-mobile-alt me-1"></i> **Sinpe Rifa:** {{ rifa.sinpe_phone_default or 'No Configurado' }}
                {% if rifa.sinpe_name_default %}<span class="ms-1">({{ rifa.sinpe_name_default }})</span>{% endif %}
            </p>
        </div>
        
        {% if group.is_canceled == 1 %}
            <span class="badge bg-green-700 text-white font-bold px-3 py-2 rounded-full">CANCELADO</span>
        {% endif %}
    </div>

    <!-- Cuerpo del Card: Números y Botón de Acción -->
    <div class="card-body p-4 d-flex flex-column justify-content-between">
        
        <!-- Total de Venta por Usuario (Solo Superusuario) -->
        {% if current_user.is_authenticated and current_user.is_superuser() %}
            <div class="mb-3 p-3 bg-indigo-50 border border-indigo-200 rounded-lg shadow-sm">
                <p class="text-sm font-medium text-indigo-700 mb-1">Total de Venta ({{ group.numbers | length }} números):</p>
                <p class="text-2xl font-extrabold text-indigo-800 mb-0">
                    {{ formatted_price }}
                </p>
            </div>
        {% endif %}

        <!-- Números en fila horizontal y wrapping -->
        <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
            <span class="text-sm font-medium {{ text_color }}">Números:</span>
            {% for number in (group.numbers | sort) %}
                <span class="font-extrabold rounded-md px-2 py-1 text-sm 
                    {% if group.is_canceled == 1 %}
                        bg-green-400 text-white
                    {% else %}
                        bg-red-400 text-white
                    {% endif %}
                ">{{ number }}</span>
            {% endfor %}
        </div>
        
        <!-- Contenedor para Ocultar/Mostrar Botones durante la exportación -->
        <div class="action-buttons mt-auto pt-3 border-top {{ border_color | replace('300', '200') }} d-flex flex-column gap-2">

            <!-- Botones de Acción: Cancelar y Editar/Liberar (Fila de 2 botones) -->
            <div class="d-flex flex-wrap gap-2">
                
                <!-- Botón Cancelar (Solo Superusuario) -->
                {% set show_cancel = current_user.is_authenticated and current_user.is_superuser() %}
                
                {% if show_cancel %}
                    {# Botón Cancelar - Ocupa la mitad del espacio disponible #}
                    <button onclick="confirmCancellation('{{ group.selection_ids | join(',') }}', '{{ group.customer_name }}', {{ group.is_canceled }})"
                        class="btn btn-sm w-50 flex-grow-1 inline-flex items-center justify-content-center font-medium rounded-xl transition 
                        {% if group.is_canceled == 1 %}
                            btn-success disabled bg-green-500 text-white border-green-700 cursor-not-allowed
                        {% else %}
                            btn-outline-success hover:bg-green-100
                        {% endif %}
                    ">
                        <i class="fas fa-ban me-1"></i> 
                        {{ 'CANCELADO' if group.is_canceled == 1 else 'Marcar Cancelado' }}
                    </button>

                    {# Botón Editar / Liberar - Ocupa la otra mitad del espacio disponible #}
                    <button onclick="openEditModal('{{ group.selection_ids | join(',') }}', '{{ (group.numbers | sort) | join(', ') }}', '{{ group.customer_name }}', '{{ group.customer_phone }}')"
                        class="btn btn-sm w-50 flex-grow-1 inline-flex items-center justify-content-center font-medium rounded-xl transition hover:bg-red-100 btn-outline-danger">
                        <i class="fas fa-edit me-1"></i> Editar / Liberar
                    </button>
                {% else %}
                    {# Si no es superusuario, solo muestra Editar/Liberar (ocupa 100%) #}
                    <button onclick="openEditModal('{{ group.selection_ids | join(',') }}', '{{ (group.numbers | sort) | join(', ') }}', '{{ group.customer_name }}', '{{ group.customer_phone }}')"
                        class="btn btn-sm w-100 inline-flex items-center justify-content-center font-medium rounded-xl transition hover:bg-red-100 btn-outline-danger">
                        <i class="fas fa-edit me-1"></i> Editar / Liberar
                    </button>
                {% endif %}
            </div>
            
            <!-- Variables para el Sinpe de la Rifa -->
            {% set sinpe_phone = rifa.sinpe_phone_default or 'No configurado' %}
            {% set sinpe_name = rifa.sinpe_name_default or 'N/A' %}

            <!-- Botón WhatsApp -->
            {% set first_digit = group.customer_phone | default('0') | string | slice(0, 1) %}
            
            {% set show_wa = current_user.is_authenticated and current_user.is_superuser() and group.customer_phone | length == 8 %} 

            {% if show_wa %}
                {# MENSAJE PARA EL BOTÓN NORMAL (CON DESTINATARIO) #}
                {% set wa_text = "¡Hola *%s*! Te confirmo tu selección de número(s) para la rifa *%s* (#%s). Tus números son: *%s*.\n\nEl total a pagar es de: *%s*.\nLa fecha del sorteo es: *%s*.\n\nEl Sinpe Móvil para el pago es: *%s* (a nombre de: *%s*).\n\nPara confirmar su compra, por favor enviar el comprobante de pago."|format(group.customer_name, rifa.prize, rifa.raffle_number, numbers_list, formatted_price, rifa.raffle_date, sinpe_phone, sinpe_name) %}
                
                <a href="https://wa.me/506{{ group.customer_phone }}?text={{ wa_text | urlencode }}"
                   target="_blank"
                   class="btn btn-sm w-100 mt-0 inline-flex items-center justify-content-center font-medium rounded-xl transition bg-green-600 text-white hover:bg-green-700"
                   title="Enviar mensaje de WhatsApp a {{ group.customer_name }} con números, total y fecha">
                    <i class="fab fa-whatsapp me-1"></i> Enviar Info por WhatsApp
                </a>
            {% endif %}

            <!-- Botón Exportar Card a PNG (Debajo de WhatsApp) -->
            {% if current_user.is_authenticated and current_user.is_superuser() %}
            <div class="mt-2">
                {# MENSAJE PARA EL BOTÓN DE EXPORTAR (SIN DESTINATARIO) #}
                {% set wa_message_export_no_dest = "¡Hola! Ya puedes encontrar la imagen de la tarjeta de tu(s) número(s) en tu galería de fotos.\n\n_El Sinpe Móvil para el pago es: *%s* (a nombre de: *%s*)._\n\nPor favor, adjúntala y envíala a tu cliente."|format(sinpe_phone, sinpe_name) %}
                
                {# MODIFICACIÓN: Se llama a la función con el número de teléfono vacío para forzar la apertura de la app sin destinatario. #}
                <button type="button" 
                        onclick="exportCardToPng('{{ card_id }}', '{{ group.customer_name }}', '{{ rifa.raffle_number }}', '', '{{ wa_message_export_no_dest | urlencode }}')"
                        class="w-full btn btn-sm bg-indigo-500 text-white font-medium rounded-xl transition hover:bg-indigo-600 shadow-md">
                    <i class="fas fa-camera me-1"></i> Exportar Card a PNG y Enviar WA
                </button>
            </div>
            {% endif %}

        </div>
    </div>

    </div>

</div>
{% endfor %}
</div>

</div>
{% else %}
<div class="text-center p-5 bg-gray-100 rounded-xl">
<p class="text-xl text-gray-600 font-medium">¡Aún no hay números vendidos! Sé el primero.</p>
</div>
{% endif %}

</div>
<!-- FIN: Diseño de Tarjetas para Números Vendidos -->

</div>

<!-- Botón Flotante para Móvil (d-lg-none) -->

<button id="floating-select-button"
data-bs-toggle="modal" data-bs-target="#selection-modal-bs"
class="d-lg-none fixed bottom-3 left-1/2 transform -translate-x-1/2 z-40
py-3 px-6 bg-indigo-600 text-white font-bold
rounded-full hover:bg-indigo-700 transition transform hover:scale-105">
<i class="fas fa-hand-pointer me-2"></i> Seleccionar Números
</button>

<!-- MODAL DE INFORMACIÓN DE RIFA (Bootstrap Modal) -->

<div class="modal fade" id="raffle-info-modal-bs" tabindex="-1" aria-labelledby="raffleInfoModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered modal-lg">
<div class="modal-content rounded-xl">
<div class="modal-header border-bottom-0">
<h2 class="modal-title text-2xl font-bold text-gray-800" id="raffleInfoModalLabel">Detalles de la Rifa</h2>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body p-4">
<div class="row g-4">
<div class="col-12 col-lg-6">
<!-- Imagen ahora es clickable para abrir el modal de zoom -->
<div
class="cursor-pointer"
data-bs-toggle="modal"
data-bs-target="#image-zoom-modal-bs"
onclick="openZoomModal('{{ url_for('static', filename='uploads/' + rifa.image_filename) }}')"
>
<img src="{{ url_for('static', filename='uploads/' + rifa.image_filename) }}"
alt="Imagen del Premio"
class="rounded-lg object-cover w-full max-w-full h-48 md:h-64 mb-4 border border-gray-200"
onerror="this.onerror=null;this.src='https://placehold.co/400x300/e0e7ff/3f51b5?text=Sin+Imagen';"
>
</div>
<div class="space-y-3">
<p class="text-xl font-semibold text-indigo-700">Premio: <span class="text-2xl font-bold text-indigo-900">{{ rifa.prize }}</span></p>
<p class="text-gray-600"><i class="fas fa-calendar-alt me-2 text-indigo-500"></i> Fecha del Sorteo: <span class="font-medium text-gray-800">{{ rifa.raffle_date }}</span></p>
{% if rifa.raffle_time %}
<p class="text-gray-600"><i class="fas fa-clock me-2 text-indigo-500"></i> Hora Estimada: <span class="font-medium text-gray-800">{{ rifa.raffle_time }}</span></p>
{% endif %}
<p class="text-gray-600"><i class="fas fa-tag me-2 text-indigo-500"></i> Precio por Número: <span class="text-xl font-extrabold text-green-600">₡{{ "%.2f"|format(rifa.price) }}</span></p>

    {% if current_user.is_authenticated and current_user.is_superuser() %}
        <div class="mt-3">
            <a href="{{ url_for('rifas.editar_rifa', raffle_id=rifa.id) }}" class="btn btn-warning text-white font-medium rounded-xl hover:bg-yellow-600 transition">
                <i class="fas fa-edit me-2"></i> Editar Rifa (Admin)
            </a>
        </div>
    {% endif %}
    
</div>

</div>

<div class="col-12 col-lg-6">
<h3 class="text-xl font-bold text-gray-800 mb-3 border-bottom pb-1">Descripción:</h3>
<p class="text-gray-700 whitespace-pre-wrap">{{ rifa.detail }}</p>

    <!-- SINPE DE LA RIFA (Dueño) - MOVIDO AL LADO DE LA DESCRIPCIÓN para que se vea siempre-->
    {% if rifa.sinpe_phone_default %}
    <div class="mt-4 p-3 bg-green-50 border border-green-300 rounded-lg shadow-sm">
        <h4 class="text-lg font-bold text-green-800 mb-2">
            <i class="fas fa-mobile-alt me-1"></i> Sinpe Móvil de la Rifa
        </h4>
        <p class="text-gray-700 mb-1">
            <span class="font-semibold">Teléfono:</span> **{{ rifa.sinpe_phone_default }}**
        </p>
        <p class="text-gray-700 mb-0">
            <span class="font-semibold">Nombre Registrado:</span> **{{ rifa.sinpe_name_default or 'No especificado' }}**
        </p>
        <p class="text-xs text-green-600 mt-1 mb-0">
            Este es el Sinpe al que se debe realizar el pago.
        </p>
    </div>
    {% endif %}
</div>

</div>

</div>

</div>

</div>

<!-- MODAL DE SELECCIÓN DE NÚMEROS (Mobile - Bootstrap Modal) -->

<div class="modal fade" id="selection-modal-bs" tabindex="-1" aria-labelledby="selectionModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content rounded-xl">
<div class="modal-header border-bottom-0">
<h2 class="modal-title text-2xl font-bold text-indigo-700" id="selectionModalLabel">Seleccionar Números</h2>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<div class="modal-body p-4">
<form method="POST" action="{{ url_for('rifas.detalle_rifa', raffle_id=rifa.id) }}" id="selection-modal-form">
<input type="hidden" name="action" value="add_selection">
<input type="hidden" name="selected_numbers" id="modal_selected_numbers_input" value="">

<div class="mb-3 p-3 bg-pastel-blue rounded-xl border border-blue-300">
<label class="form-label text-sm font-medium text-gray-700 mb-1">Números a Comprar:</label>
<span id="modal_selected_numbers_display" class="d-block text-lg font-extrabold text-blue-800">Ninguno</span>
</div>

<div class="space-y-3">
<div>
<label for="modal_customer_name" class="form-label text-sm font-medium text-gray-700">Nombre:</label>
<input type="text" name="customer_name" id="modal_customer_name" required class="form-control rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3">
</div>
<div>
<label for="modal_customer_phone" class="form-label text-sm font-medium text-gray-700">Teléfono (8 dígitos):</label>
<input type="tel" name="customer_phone" id="modal_customer_phone" pattern="[0-9]{8}" maxlength="8" required class="form-control rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3">
</div>

{# SECCIÓN ELIMINADA: MÉTODO DE PAGO DEL CLIENTE (Móvil) #}
{# Eliminado: <div class="pt-2 border-top border-gray-200 space-y-3">... #}
{# Eliminado: <div id="sinpe_fields_mobile" class="space-y-3 pt-2 d-none">... #}

<div>
<label for="modal_selection_password" class="form-label text-sm font-medium text-gray-700">Contraseña de Protección:</label>
<div class="input-group mt-1">
<input type="password" name="selection_password" id="modal_selection_password" required minlength="4" class="form-control rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3">
<button type="button" onclick="togglePasswordVisibility('modal_selection_password')" class="btn btn-outline-secondary border-0 text-gray-500 hover:text-indigo-600 transition"
style="border-top-right-radius: 0.75rem !important; border-bottom-right-radius: 0.75rem !important;">
<i class="fas fa-eye-slash" id="toggle_modal_selection_password_icon"></i>
</button>
</div>
<p class="text-xs text-gray-500 mt-1">Necesaria para editar/eliminar la selección más tarde.</p>
</div>
</div>

<button type="submit" id="modal_submit_button" disabled class="mt-3 w-full btn text-lg font-medium text-white transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
Comprar Números Seleccionados
</button>

</form>

</div>

</div>

</div>

</div>

<!-- MODAL DE EDICIÓN/LIBERACIÓN (Bootstrap Modal) -->

<div class="modal fade" id="edit-modal-bs" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content rounded-xl">

<div class="modal-header border-bottom-0 pt-4">
<div class="d-flex align-items-start">
<div class="flex-shrink-0 d-flex align-items-center justify-content-center h-10 w-10 rounded-circle bg-indigo-100 me-3">
<i class="fas fa-unlock-alt text-indigo-600"></i>
</div>
<div class="flex-grow-1">
<h3 class="modal-title fs-5 font-medium text-gray-900" id="editModalLabel">
Detalles de la Selección <span id="modal-number-display" class="font-extrabold text-indigo-700"></span>
</h3>
<p class="text-sm text-gray-500">
Verifica la información del cliente antes de proceder a editar o liberar.
</p>
</div>
</div>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form method="POST" action="{{ url_for('rifas.detalle_rifa', raffle_id=rifa.id) }}">
<div class="modal-body pt-0">
<!-- Se utiliza 'view_selection' como acción para diferenciar, aunque el backend solo implemente delete/edit -->
<input type="hidden" name="action" id="modal-action" value="delete_selection">
<input type="hidden" name="selection_ids" id="modal-selection-ids">

<!-- Información del Cliente (READ-ONLY) -->

<div class="p-3 bg-gray-50 rounded-lg mb-3">
<h6 class="text-sm font-bold text-gray-700 mb-2 border-bottom pb-1">Datos del Cliente:</h6>
<div class="mb-2">
<label class="form-label text-xs font-medium text-gray-600 mb-0">Nombre:</label>
<input type="text" id="customer_name_display" readonly class="form-control form-control-sm bg-white font-semibold border-0">
</div>
<div>
<label class="form-label text-xs font-medium text-gray-600 mb-0">Teléfono:</label>
<input type="text" id="customer_phone_display" readonly class="form-control form-control-sm bg-white font-semibold border-0">
</div>
</div>

<!-- Contraseña para ACCIONES (Editar o Liberar) -->

<div class="mb-3">
<label for="edit_password" class="form-label text-sm font-medium text-gray-700">Contraseña de Protección:</label>
<div class="input-group mt-1">
<input type="password" name="edit_password" id="edit_password"
{% if not current_user.is_authenticated or not current_user.is_superuser() %}required{% endif %}
class="form-control rounded-xl border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-3">
<button type="button" onclick="togglePasswordVisibility('edit_password')" class="btn btn-outline-secondary border-0 text-gray-500 hover:text-indigo-600 transition"
style="border-top-right-radius: 0.75rem !important; border-bottom-right-radius: 0.75rem !important;">
<i class="fas fa-eye-slash" id="toggle_edit_password_icon"></i>
</button>
</div>
{% if current_user.is_authenticated and current_user.is_superuser() %}
<p class="text-xs text-indigo-500 mt-1">Como Superusuario, la contraseña es opcional para la liberación/edición.</p>
{% else %}
<p class="text-xs text-gray-500 mt-1">Requerida para cualquier acción sobre esta selección.</p>
{% endif %}
</div>

</div>

<div class="modal-footer d-grid gap-2 d-sm-flex justify-content-sm-end">
<!-- Botón para Editar (Si el backend lo implementa, puede cambiar 'action' a 'edit_selection') -->
<button type="submit" id="btn-edit-selection"
class="btn btn-warning rounded-xl text-base font-medium transition"
onclick="document.getElementById('modal-action').value = 'edit_selection'">
<i class="fas fa-edit me-2"></i> Editar Cliente
</button>

<!-- Botón para Liberar -->

<button type="submit" id="btn-delete-selection"
class="btn btn-danger rounded-xl text-base font-medium transition"
onclick="document.getElementById('modal-action').value = 'delete_selection'">
<i class="fas fa-trash-alt me-2"></i> Liberar Números
</button>

</div>

</form>

</div>

</div>

</div>

<!-- NEW MODAL: Image Zoom Modal (Bootstrap Modal) -->

<div class="modal fade" id="image-zoom-modal-bs" tabindex="-1" aria-labelledby="imageZoomModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered modal-xl modal-fullscreen-lg-down">
<div class="modal-content rounded-xl bg-black">
<div class="modal-header border-bottom-0 bg-dark rounded-top-xl p-3">
<h5 class="modal-title text-white" id="imageZoomModalLabel">Vista Ampliada de la Imagen</h5>
<div>
<button type="button" class="btn btn-secondary btn-sm me-2" onclick="handleZoom(1)">
<i class="fas fa-search-plus me-1"></i> Zoom In
</button>
<button type="button" class="btn btn-secondary btn-sm me-2" onclick="handleZoom(-1)">
<i class="fas fa-search-minus me-1"></i> Zoom Out
</button>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
</div>

<div class="modal-body p-2 d-flex justify-content-center align-items-center overflow-auto" id="zoom-modal-body">
<img id="zoom-image" src="" alt="Imagen ampliada"
class="max-w-full max-h-full object-contain transition-transform duration-300 cursor-move"
style="transform: scale(1); transform-origin: center center;">
</div>

</div>

</div>

</div>

<!-- NEW MODAL: Cancel Confirmation Modal (Bootstrap Modal) -->

<div class="modal fade" id="cancel-confirm-modal-bs" tabindex="-1" aria-labelledby="cancelConfirmModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content rounded-xl">

<div class="modal-header border-bottom-0 pt-4 bg-red-50 rounded-top-xl">
<div class="d-flex align-items-start">
<div class="flex-shrink-0 d-flex align-items-center justify-content-center h-10 w-10 rounded-circle bg-red-100 me-3">
<i class="fas fa-exclamation-triangle text-red-600"></i>
</div>
<div class="flex-grow-1">
<h3 class="modal-title fs-5 font-bold text-red-700" id="cancelConfirmModalLabel">
Confirmar Cancelación
</h3>
<p class="text-sm text-gray-500">
Esta acción es irreversible y solo marca la selección como cancelada (Verde).
</p>
</div>
</div>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<!-- El formulario se posteará para la acción de cancelación -->

<form method="POST" action="{{ url_for('rifas.detalle_rifa', raffle_id=rifa.id) }}">
<div class="modal-body pt-0">
<input type="hidden" name="action" value="cancel_selection">
<!-- Este input se llena con JS: selectionIds -->
<input type="hidden" name="selection_ids" id="modal-cancel-selection-ids">

<div class="p-4 bg-gray-50 rounded-lg mb-3 border border-red-200">
<p class="text-base text-gray-700 mb-2">
¿Confirma que el cliente
<span id="modal-cancel-customer-name" class="font-extrabold text-red-800"></span>
ha CANCELADO su selección?
</p>
<p class="text-sm text-red-600 font-medium">
Los números se marcarán como CANCELADOS en el sistema y aparecerán en color verde sólido en la lista de vendidos. No se liberan a la venta.
</p>
</div>

</div>

<div class="modal-footer d-flex justify-content-between">
<button type="button" class="btn btn-secondary rounded-xl font-medium" data-bs-dismiss="modal">
Cancelar
</button>
<!-- Botón de Confirmación para enviar la acción POST -->
<button type="submit"
class="btn btn-success rounded-xl text-base font-medium transition hover:bg-green-700">
<i class="fas fa-check-circle me-2"></i> Confirmar Cancelación
</button>
</div>

</form>

</div>

</div>

</div>

<!-- CND de html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Lógica JS Adicional para campos de pago del cliente y Exportar Card -->
<script>
    // Función para mostrar/ocultar campos de Sinpe del cliente (AHORA INACTIVA EN HTML)
    function toggleSinpeFields(selectId, fieldsId) {
        // Esta función ya no es necesaria en el HTML pero se mantiene vacía para evitar errores JS
        console.log("toggleSinpeFields ha sido eliminado del HTML.");
        // Se elimina la lógica de DOM del JS al final de este archivo.
    }

    /**
     * NUEVA FUNCIÓN: Exportar Card a PNG usando html2canvas y luego abrir WhatsApp.
     * @param {string} cardId - El ID del elemento de la tarjeta a capturar.
     * @param {string} customerName - Nombre del cliente (solo para nombre de archivo).
     * @param {string} raffleNumber - Número de la rifa (solo para nombre de archivo).
     * @param {string} customerPhone - Teléfono del cliente. Si está vacío, abre WA sin destinatario.
     * @param {string} waMessage - Mensaje de WhatsApp codificado.
     */
    function exportCardToPng(cardId, customerName, raffleNumber, customerPhone, waMessage) {
        const cardElement = document.getElementById(cardId);
        
        if (!cardElement) {
            console.error('Elemento de tarjeta no encontrado:', cardId);
            return;
        }

        // 1. Ocultar todos los botones de acción antes de la captura
        // Usamos la clase 'd-none' para que no se muestren en la captura
        const elementsToHide = cardElement.querySelectorAll('.action-buttons');
        elementsToHide.forEach(el => {
            el.classList.add('d-none');
        });

        // Crea un nombre de archivo limpio
        const cleanName = customerName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const fileName = `rifa_${raffleNumber}_${cleanName}.png`;

        // Opciones para asegurar que el fondo se pinte correctamente y mejor calidad
        const options = {
            allowTaint: true,
            useCORS: true,
            backgroundColor: '#ffffff', // Fondo blanco explícito
            scale: 2 // Escala para mejor calidad
        };

        // Usa html2canvas para capturar el elemento
        html2canvas(cardElement, options).then(canvas => {
            // 2. Volver a mostrar los botones inmediatamente después de la captura
            elementsToHide.forEach(el => {
                el.classList.remove('d-none');
            });
            
            // Convierte el canvas a una URL de datos
            const image = canvas.toDataURL('image/png');
            
            // Crea un enlace de descarga y simula un clic para descargar la imagen
            const a = document.createElement('a');
            a.href = image;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // 3. Abrir WhatsApp en una nueva pestaña
            let waUrl;
            
            // Si customerPhone está vacío (el caso que queremos para seleccionar destinatario manualmente)
            if (!customerPhone) {
                // Abre el chat sin destinatario, pero con el mensaje predefinido
                // Se utiliza el número 0 para forzar el chat o simplemente el wa.me/
                // Utilizamos el endpoint de la API para que se abra WhatsApp con el mensaje predefinido.
                // Ya que no se proporciona un número, el usuario debe seleccionar un contacto.
                waUrl = `https://wa.me/?text=${waMessage}`;
            } else {
                // Comportamiento anterior (con destinatario específico)
                waUrl = `https://wa.me/506${customerPhone}?text=${waMessage}`;
            }

            window.open(waUrl, '_blank');
            
            console.log('Imagen descargada. Se abrió WhatsApp. Por favor, adjunte la imagen descargada manualmente y seleccione el destinatario.');

        }).catch(error => {
            // 4. Asegurarse de volver a mostrar los botones incluso si hay un error
            elementsToHide.forEach(el => {
                el.classList.remove('d-none');
            });
            
            console.error('Error al exportar la tarjeta:', error);
            // Reemplazamos alert() con console.error según las reglas
            console.error('Error al generar la imagen. Consulta la consola para más detalles.');
        });
    }

    // Inicializar el estado de los campos de Sinpe al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        // Ya no es necesario inicializar el estado del método de pago aquí
    });
</script>

{% endblock %}
